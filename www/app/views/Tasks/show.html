<!--This page is to override the Crud.show of the Tasks, I specified some attributes to appear
	while editing.
	Author: Monayri
-->

#{extends 'overlay.html' /}
#{set 'moreStyles'}
<style type="text/css">
	.ac_results {
		background: #eee;
		border: 2px solid #bbb;
		border-radius:10px;
		border-top-right-radius: 0;
		border-top-left-radius: 0;
	}
	.ac_results ul {
		list-style: none;
	}
	.ac_results ul li {
		font-size:small;
	}
	
</style>
#{/set}

<script type="text/javascript" src="@{'/public/javascripts/jquery.autocomplete.js/'}"></script>

<div id="crudShow" class="${type.name}">
	
	<h2 id="crudShowTitle">&{'crud.show.title', type.modelName}</h2>
	<font color="Red">${message}</font>

	<div class="objectForm">
	#{form action:@save(object.id), enctype:'multipart/form-data'}
	#{crud.form fields:['parent','description', 'taskType', 'taskStatus', 'component'  , 'estimationPoints', 'reporter', 'dependentTasks','taskSprint', 'assignee', 'reviewer', 'comment', 'subTasks']}		
			#{crud.custom 'parent'}
			#{if object.parent!=null}
			<label for="task_parent">Parent</label> 
			<p>
			<span id="task_Story2"><font color="green">${object.parent.description}</font></span> 
			</p>
			#{/if}
			#{/crud.custom }
			
			#{crud.custom 'description' }
			<label for="object_description">Description	</label>
			<textarea id="object_description"  name="object.description" ROWS="4" COLS="60" onclick="f();">${object.getSummary()}</textarea>
    		<span class="crudHelp" style="color:red">*</span>
			<div style="display:none" class="d">Ex: As a/an product role, description</div>
			<span class="error"></span>
			#{/crud.custom}
		
					
			#{crud.custom 'taskStatus'}
			<p>
			<label for="task_taskStatus">Status</label>
			<select id="object_taskStatus" name="object.taskStatus@id">
								#{list items:statuses ,as :'Status'}
									<option value="${Status.id}"#{if object.taskStatus == Status} selected#{/if}>${Status.name}</option>
								#{/list}		
			</select>
			</p>
			#{/crud.custom }
				
		
			
			#{crud.custom 'taskType'}
			<p>
			<label for="task_type">Type</label> 
			<select id="object_taskType" name="object.taskType@id" onchange="getType();">
								#{list items:types ,as :'Type'}
									<option value="${Type.id}"#{if object.taskType == Type} selected#{/if}>${Type.name}</option>
								#{/list}		
			</select>
			</p>
			#{/crud.custom }
			
			#{crud.custom 'component'}
			#{if object.project.components.size()==1 || insprint}
			#{/if}
			
			#{else}
			<p>
			<label for="task_type">Component</label>
			<select id="object_component" name="object.component@id" onchange="getUsers()">
								#{list items:object.project.components ,as :'component'}
								#{if component.name=='default component'}
									<option value="${component.id}"#{if object.component == component} selected#{/if}>None</option>
								#{/if}
								#{else}	
									<option value="${component.id}"#{if object.component == component} selected#{/if}>${component.name}</option>
								#{/else}
								#{/list}		
			</select>
			</p>
			#{/else}
			#{/crud.custom }
			
			#{crud.custom 'estimationPoints'}
			#{ifnot object.subTasks}
			<p> 
			<label for="object_estimationPoints">Estimation Points</label> 
			<input id="object_estimationPoints" type="text" name="object.estimationPoints" 
			size="5"  value = "${object.estimationPoints}"/> 
			<span class="crudHelp" ><font color="Red">*</font>Numeric.</span> 
 			</p>
 			#{/ifnot} 
			#{/crud.custom }
			
			
			#{crud.custom 'reporter'}
			<p>
			<label for="task_reporter">Reporter</label> 
			<span id="task_reporter2" ><font color="green">${object.reporter.name}</font></span> 
			</p>
			#{/crud.custom }
			
			#{crud.custom 'assignee'}
			<p>
			<label for="object_assignee">Assignee</label>
			<select id="object_assignee" name="object.assignee@id"  onchange="getType();">
					<option value="">(None)</option>
					#{list items:users ,as :'User'}
					<option value="${User.id}"#{if object.assignee == User} selected#{/if}>${User.name}</option>
					#{/list}		
	</select>
			</p>
			#{/crud.custom}
	
			#{crud.custom 'reviewer'}
			<label for="object_reviewer">Reviewer</label>
			<select id="object_reviewer" name="object.reviewer@id" >
				<option value="">(None)</option>
				#{list items:revs ,as :'User'}
				#{if object.assignee!=null}
				#{if object.assignee.id!=User.id}
				<option value="${User.id}"#{if object.reviewer == User} selected#{/if}>${User.name}</option>
				#{/if}
				#{/if}
				#{else}
				<option value="${User.id}"#{if object.reviewer == User} selected#{/if}>${User.name}</option>
				#{/else}
				#{/list}		
			</select>
			#{/crud.custom}
			
			#{if dependencies.size()>1}
			#{crud.custom 'dependentTasks'}
			<p>
			<label for="object_dependentTasks"> Dependent Tasks</label> 
			<input type="hidden" name="object.dependentTasks@id" value="" /> 
			<select id="object_dependentTasks" name="object.dependentTasks@id" multiple="yes"> 
			#{list items:dependencies ,as :'Task'}
			#{if object!=Task}
			<option value="${Task.id}" #{if object.dependentTasks.contains(Task)}selected#{/if}>${Task.description}</option>
			#{/if}
			#{/list} 
			</select> 
			</p>
			#{/crud.custom }
			#{/if}
			#{else}
			#{crud.custom 'dependentTasks'}
			#{/crud.custom }
			#{/else}
			
			#{if object.project.sprints.size()>0}
			#{crud.custom 'taskSprint'}
			<p>
			<label for="object_taskSprint">Sprint</label>
			#{if object.taskSprint!=null}
			#{if object.taskSprint.ended || insprint} 
			<span id="task_taskSprint" ><font color="green">sprint ${object.taskSprint.sprintNumber}</font></span>
			#{/if}
			#{else}
			<select id="object_taskSprint" name="object.taskSprint@id">
			<option value="">(None)</option>
			#{list items:object.project.sprints ,as :'sprint'}
			#{ifnot sprint.ended}
			<option value="${sprint.id}"#{if object.taskSprint == sprint} selected#{/if}>sprint ${sprint.sprintNumber}</option>
			#{/ifnot}
			#{/list}		
			</select>
			#{/else}
			#{/if}
			#{else} 
			<select id="object_taskSprint" name="object.taskSprint@id">
			<option value="">(None)</option>
			#{list items:object.project.sprints ,as :'sprint'}
			#{ifnot sprint.ended}
			<option value="${sprint.id}"#{if object.taskSprint == sprint} selected#{/if}>sprint ${sprint.sprintNumber}</option>
			#{/ifnot}
			#{/list}		
			</select>
			#{/else}
			</p>
			#{/crud.custom }
			#{/if}
			#{else}
			#{crud.custom 'taskSprint'}
			#{/crud.custom }
			#{/else}
			
			#{crud.custom 'comment'}
				<label for="object_comment">Comments and Actions</label><br/>
				<input type="hidden" name="object.comment@id" value="" /> 
				<textarea id="object_comment" name="object.comment" style="width:100%"></textarea>
				<div name="comments">
				<table>
				#{list items:comments, as:'comment'}
					#{ifnot comment.deleted}
						<tr>
							<td><b>${comment.author} (<i><span class="formatTime">${comment.timeOfComment}</span></i>)</b></td>
							<td>${comment.comment.raw()} - <a href="#" onclick="deleteComment(${comment.id}, ${object.id});"><img src="@{'public/images/famfam/delete.png'}"></a></td>
						</tr>
					#{/ifnot}
				#{/list}
				</table>
				</div>
			#{/crud.custom}
			
			#{if object.subTasks.size()==0}
			#{crud.custom 'subTasks'}
			#{/crud.custom}
			#{/if}
			
		#{/crud.form }
			
		<p class="crudButtons">
			<input type="submit" name="_save" value="&{'crud.save', type.modelName}" />
		</p>
	#{/form}
	</div>
	#{if deletable}
	<form action="@{delete(object.id)}?x-http-method-override=DELETE" method="POST" accept-charset="utf-8" enctype="application/x-www-form-urlencoded" onSubmit="return confirm('${message2}');">	
				<p class="crudDelete">
					<input type="submit" value="&{'crud.delete', type.modelName}" />
				</p>
	</form>
	#{/if}
	
	#{if !deletable}
		<label><font color="green">&nbsp;&nbsp;The task can't be deleted As some other tasks depends on it !</font></label>
	#{/if}
</div>

<script type="text/javascript">

	var data='${productRoles}'.split("-");
	$("#object_description").autocomplete(data);
	
	function f()
	{
		$('.d').css('display','inline-block');
	}
	
	function product_role(id)
	{
		$.post('/Storys/addProductRole' ,			
			{projectID:id,						
			description:$("#example").val()});
	} 

	function change_reviewers(projId){
    var value = $('#object_component').val();
	var value2 = $('#object_assignee').val();
	var compId = $('#object_component').val();
    $.post('@{reviewers}', {id:value, id2 : value2, compId: compId, projId:projId}, function(data){
		str = '<option value="">(None)</option>';
		$.each(data, function(id, item){
			str += '<option value='+item.id+'>'+item.name+'</option>';
		});
		$('#object_reviewer').html( str );
	});
    }

	function deleteComment(cId,tIdd){
	if(confirm("Are you sure you want to delete this comment? This action can not be undone.")){
		$.post('/comments/deleteComment', {id:cId}, function(msg){
			$.bar({message:msg});
		});
		$.post('/comments/listCommentsOfTask', {tId:tIdd}, function(data){
			$("[name='comments']").html(data);
		});
	}
	}
function getUsers()
{
	var compId = $('#object_component').val();
	var typeId = $('#object_taskType').val();
	$.post('@{componentUsers}', {cid : compId}, function(data){
		str = '<option value="">(None)</option>';
		$.each(data, function(id, item){
			str += '<option value='+item.id+'>'+item.name+'</option>';
		});
		$('#object_assignee').html( str );
	}); 
	$.post('@{typeReviewer}', {typeId : typeId, componentId:compId}, function(data){
		str = '<option value="">(None)</option>';
		$.each(data, function(id, item){
			str += '<option value='+item.id+'>'+item.name+'</option>';
		});
		$('#object_reviewer').html( str );
	}); 
}
function getType()
{
	var compId = $('#object_component').val();
	var typeId = $('#object_taskType').val();
	var assigneeId = $('#object_assignee').val();
	$.post('@{typeReviewer}', {typeId : typeId, componentId:compId, assigneeId:assigneeId}, function(data){
		str = '<option value="">(None)</option>';
		$.each(data, function(id, item){
			str += '<option value='+item.id+'>'+item.name+'</option>';
		});
		$('#object_reviewer').html( str );
	}); 
}
	</script>

