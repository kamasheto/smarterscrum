<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <title>#{get 'title' /}</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <link rel="stylesheet" type="text/css" media="screen" title="original" href="@{'/public/stylesheets/main.css'}"/>
		<link rel="alternate stylesheet" type="text/css" media="screen" title="blue" href="@{'/public/stylesheets/mainblue.css'}" />
		<link rel="alternate stylesheet" type="text/css" media="screen" title="red" href="@{'/public/stylesheets/mainred.css'}" />
		<link rel="alternate stylesheet" type="text/css" media="screen" title="green" href="@{'/public/stylesheets/maingreen.css'}" />
		<link rel="stylesheet" type="text/css" media="screen"href="@{'/public/stylesheets/tipTip.css'}"/>
        <link rel="stylesheet" type="text/css" media="screen" href="@{'/public/stylesheets/jquery-ui-1.8.custom.css'}"/>
		<link rel="stylesheet" type="text/css" media="screen" href="@{'/public/stylesheets/BreadCrumb.css'}"/>
		<link rel="stylesheet" type="text/css" media="screen" href="/public/stylesheets/jquery.gritter.css"/>
		<link rel="stylesheet" type="text/css" media="screen" href="/public/stylesheets/jquery.jbar.css"/>
		<link rel="shortcut icon" href="@{'public/images/favicon.ico'}" type="image/x-icon"/> 
        #{get 'moreStyles' /}
 
        <script src="@{'/public/javascripts/jquery-1.4.min.js'}" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript" src="@{'public/javascripts/jquery-ui-1.8.custom.min.js'}"> </script>
		<script type="text/javascript" src="@{'public/javascripts/timepicker.js'}"> </script>
		<script type="text/javascript" src="@{'public/javascripts/jquery.jBreadCrumb.1.1.js'}"> </script>
        <script src="@{'/public/javascripts/date.js'}" type="text/javascript" charset="utf-8"></script>
       	<script src="@{'/public/javascripts/jquery.tipTip.js'}" type="text/javascript"charset="utf-8"></script>
       	<script src="@{'/public/javascripts/md5.js'}" type="text/javascript"charset="utf-8"></script>
       	<script src="@{'/public/javascripts/more.js'}" type="text/javascript"charset="utf-8"></script>
		<script type="text/javascript" src="/public/javascripts/jquery.gritter.min.js"></script>
        <script src="@{'/public/javascripts/jquery.bar.js'}" type="text/javascript" charset="utf-8"></script>
        #{get 'moreScripts' /}
              <script src="@{'/public/javascripts/skinSwitcher.js'}" type="text/javascript" charset="utf-8"></script>
		
        <script type="text/javascript">
       		$(function(){

				/**script to move the login panel to the sidebar**/
				#{if connected}
				$('#logger').html('');
				#{/if}
				#{else}
				$('#logger').html($('#login').html());
				$('#login').html('');
				#{/else}

				/* Script to remove sidebar	
				if($('.sideBarElements').html()=='')
				{
					$('#theSide').remove();
					$('#theContent').css('padding','20px');
				}
				*/
				function signIn(id)
				{
					$.post('/ChatSystem/enterChat',{id:id});
				}
				
				function signOut(id)
				{
					$.post('/ChatSystem/leaveChat',{id:id});
				}

       			$("#breadCrumb").jBreadCrumb();
       			$('.formatDate').each(function(){
					$(this).html( formatDate( new Date(getDateFromFormat($(this).html(),'yyyy-MM-dd HH:mm:ss')), 'd MMM, yyyy') );
				});
       			$('.formatTime').each(function(){
					$(this).html( formatDate( new Date(Number($(this).html())), 'd MMM, yyyy hh:mma') );
				});
       		
   			    $("a").tipTip({delay:0});
   			    $("td").tipTip({delay:0});
   			    $("span").tipTip({delay:0});
   			    
   			    $("button").addClass("ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only",0);
   			    $("a button").addClass("ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only",0);
   			    $("input[type='submit']").addClass("ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only",0);
   			    $("input[type='button']").addClass("ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only",0);
   			    $("input[type='ok']").addClass("ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only",0);
   			    $("input[type='add']").addClass("ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only",0);
   			    $("input[type='send']").addClass("ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only",0);

   			    $('div.crudField').each(function(){
						if ($(this).html().trim() == '') {
							$(this).remove();
						}
   	   			    });
   			    #{if connected}
	 			getNotifications();
				ping();
   			    #{/if}
       		});
        </script>
</head>
<body onload="#{get 'onLoad' /}">
<div style="position:absolute; top:117px; right:10px">
#{if connected?.isAdmin}
	<a class="aDIV topCornersRounded" href="/admin" style="color: #E5A1A5;" title="View the admin panel">Admin Panel</a>
#{/if}
	<a class="aDIV topCornersRounded" href="@{About.index}" title="read aboout SmartSoft?">About Us</a>
	<a class="aDIV topCornersRounded" href="@{Show.users}" title="show users?">Users</a>
	<a class="aDIV topCornersRounded" href="@{Show.projects}" title="view all projects?">Projects</a> 
</div>
<div style="position:absolute; top:0px; right:10px">
	<div class="inline-block right" style="background-color:#111; width: 20px; height: 20px;">
		<div class="curlyNotchTopLeft makeTransparent"></div>
	</div>
	<div class="bottomCornersRounded right" style="padding: 10px 10px 10px 10px; background-color: #111; overflow: auto;">
		<input class="search" type="text" /><input class="searchBtn" type="button" value="search" />
	</div>	
	<div class="inline-block right" style="background-color:#111; width: 20px; height: 20px;">
		<div class="curlyNotchTopRight makeTransparent"></div>
	</div>
</div>
<table cellpadding="0" style="width: 100%" class="myTables">
	<tr>
		<td>
			<table cellpadding="0" style="width: 100%" class="myTables">
				<tr>
					<td>
						<div class="logoHolder">
							<div class="left">
								<a  href="/" title="Go back home?" id="TheLogo"></a>
							</div>
						</div>
						<div class="topper">
						#{if connected}
							Hello ${connected.name}!&nbsp;&nbsp;|&nbsp;&nbsp;
							<a href="/show/user?id=${controllers.Security.getConnected().id}">Profile</a>&nbsp;&nbsp;|&nbsp;&nbsp;
							<a href="@{Projects.myProjects()}" style="width: 120px !important" title="Want to see your projects?">My Projects</a>&nbsp;&nbsp;|&nbsp;&nbsp;
							<a href="#" id="chatlink"onclick="$('#chatroomList').slideToggle(200);$('#chatlink').toggleClass('topCornersRounded white')">Chatroom</a>&nbsp;&nbsp;|&nbsp;&nbsp;
							<a href="/secure/logout" title="Logout from the system">[x] Logout</a>&nbsp;&nbsp;|&nbsp;&nbsp;
						#{/if}
							<a href="#" id="skinlink"onclick="$('#skinList').slideToggle(200);$('#skinlink').toggleClass('topCornersRounded white')">Change Color</a>&nbsp;&nbsp;
							
						#{ifnot connected}
							<a href="@{Accounts.register}">|&nbsp;&nbsp;Register</a>
						#{/ifnot}
						#{if connected}
							<br/>
							<div id="chatroomList">
 								<div class="allCornersRounded chatroomListHolder" >
 								#{list controllers.Security.getConnected().projects, as:'proj'}
 									<a href="#" onclick="$('#chatContainer_${proj.name}').slideToggle(400);#{ifnot controllers.Security.getConnected().openChats.contains(proj.chatroom)}signIn(${proj.chatroom.id});getMessages${proj.id}();#{/ifnot}">${proj.name}</a>
 									<br/> 	
							 	#{/list}
								</div>
							</div>
							<div id="skinList">
 								<div class="allCornersRounded skinListHolder" >
 									<a href="javascript:"onclick="chooseStyle('blue', 60)">Blue</a>
 									<br/>
 									<a href="javascript:"onclick="chooseStyle('green', 60)">Green</a>
 									<br/>
 									<a href="javascript:"onclick="chooseStyle('red', 60);$('#theLogoImage').attr('src','@{'/public/images/smartsoftred.png'}');">Red</a>
 									<br/>
 									<a checked="checked"href="javascript:"onclick="chooseStyle('original', 60)">Purple</a>
								</div>
							</div>
						</div>
						<div id="chatContainer">
						#{list controllers.Security.getConnected().projects, as:'proj'}
							<div id="chatContainer_${proj.name}"style="width:225px;#{ifnot controllers.Security.getConnected().openChats.contains(proj.chatroom)}display:none;#{/ifnot}">
								<div class="chatContainerHeader">
									${proj.name} Chat 
									<a id="${proj.name}_min"class="right"href="#" title="minimize?" onclick="$('#chatHolder_${proj.name}').slideToggle(400);$('#${proj.name}_max').slideToggle(400);$('#${proj.name}_min').slideToggle(400);" style="text-decoration:none; color:#fff">[-]</a>
									<a id="${proj.name}_max"class="right"href="#" title="minimize?" onclick="$('#chatHolder_${proj.name}').slideToggle(400);$('#${proj.name}_max').slideToggle(400);$('#${proj.name}_min').slideToggle(400);" style="display:none;text-decoration:none; color:#fff">[+]</a>
									<a class="right"href="#" title="signout?" onclick="signOut(${proj.chatroom.id});$('#chatContainer_${proj.name}').slideToggle(400);" style="text-decoration:none; color:#fff">[x]</a>
								</div>
								<div id="chatHolder_${proj.name}">
									<div id="thread_${proj.name}" class="thread">
										<script type="text/html" id="message_tmpl">
											<div class="<%= message.author == 'notice' ? 'notice allCornersRounded' : message.author == '${controllers.Security.getConnected().name}' ? 'you' : 'them' %>">		
												<strong class="title" style="<%= message.author == 'notice' ? 'display:none !important' : '' %>"><%= message.author%></strong> 
												<%= message.message.replace('\n', '<br/>') %>
											</div>
										</script>
										<div id ="threader_${proj.name}"></div>
									</div>
									<div id="newMessage" class="chatboxinput">	
										<textarea id="message_${proj.name}" name="message_${proj.name}" class="chatboxtextarea"></textarea>
									</div>	
									<script type="text/javascript">
									#{if controllers.Security.getConnected().openChats.contains(proj.chatroom)}
									$(function()
									{
										retrieve${proj.id}();
										getMessages${proj.id}();
									});
									#{/if}								
									$('#message_${proj.name}').keypress(function(event)
									{
										if (event.keyCode == '13')
										{		var message = $('#message_${proj.name}').val();
										$('#message_${proj.name}').val('');
										$.post('@{ChatSystem.addMessage()}', {message: message , id:${proj.chatroom.id}}); 
										$('#message_${proj.name}').focus(); }
									});
									// Retrieve new messages
									var getMessages${proj.id} = function() {
										$.getJSON('/ChatSystem/newMessages',{id:${proj.chatroom.id}}, function(messages) {
											$(messages).each(function() {
												display${proj.id}(this);
											});
											setTimeout('getMessages${proj.id}();', 1000);
										});
									}
									// Retrieve all messages
									var retrieve${proj.id} = function() {
										$.getJSON('/ChatSystem/retrieveSinceLastLogin',{userId:${connected.id},roomId:${proj.chatroom.id}}, function(messages) {
											$(messages).each(function() {
												display${proj.id}(this);
											});
										});
									}
									// Display a message
									var display${proj.id} = function(message) {
										$('#threader_${proj.name}').append(tmpl('message_tmpl', {message: message}));
										var obj = document.getElementById('thread_${proj.name}');
										obj.scrollTop = obj.scrollHeight;
									}
									</script>
								</div>
							</div>
						#{/list}
						</div>
						#{/if}
					</td>
				</tr>
			</table>
		</td>
	</tr>
	<tr>
		<td>
			<table cellpadding="0" class="myTables" style="width: 100%; overflow: auto">
				<tr>
					<td style="width: 47px">
						<img alt="" src="@{'/public/images/topleft.png'}" />
					</td>
					<td>
						<div class="left" style="position:relative;z-index:0;background: url('@{'/public/images/topcenter.png'}') repeat-x scroll left top; height: 43px; width: 100%"></div>
					</td>
				<td style="width: 47px">
				<img alt="" src="@{'/public/images/topright.png'}" /></td>
			</tr>
		</table>
		</td>
	</tr>
	<tr>
		<td>
		<div style="padding: 0px 14px 0px 14px; vertical-align: top">
			<div style="background-color: #fff; overflow: auto;">
				<table style="width: 100%" class="myTables">
					<tr>
						<td id="theSide"style="width: 200px; vertical-align: top; border-right:1px #ddd solid">
						<div id="logger" style="padding-left:20px">
</div>
						
						
						#{if connected}
						<div class="sideBar" style="vertical-align: top">
							<div class="block">
								<div class="left inline-block ss">{</div>
								<div class="sideBarHeading inline-block left">Tools</div>		
								<div class="left inline-block ss">}</div>
							</div>
							<br style="clear:both"/>
							<div class="sideBarElements">#{get 'moreLinks' /}#{get 'moreControls'/}</div>
						</div>
						#{/if}
						</td>
						<td id="theContent"style="vertical-align: top; padding: 10px;">
						<div class="left" style=" vertical-align: top;width:100%">
							#{if connected}
							<div id="breadCrumb" class="breadCrumb module">
								<ul>
									<li><a href="/">Home</a></li>
									<li>#{get 'crumbs' /} </li>
								</ul>
							</div>
										
							
							#{/if}
							<div id="content"style="margin-top:35px;">
							#{doLayout /}
							</div>
						</div>
						</td>
					</tr>
				</table>
			</div>
		</div>
		</td>
	</tr>
	<tr>
		<td>
		<table class="myTables"cellpadding="0" class="myTables" style="width: 100%; overflow: auto">
			<tr>
				<td style="width: 43px">
				<img alt="" src="@{'/public/images/bottomleft.png'}" /></td>
				<td>
				<div class="left" style="position:relative;z-index:0;background: url('@{'/public/images/bottomcenter.png'}') repeat-x scroll left top; height: 43px; width: 100%">
				</div>
				</td>
				<td style="width: 43px">
				<img alt="" src="@{'/public/images/bottomright.png'}" /></td>
			</tr>
		</table>
		</td>
	</tr>
</table>


<div style="text-align: center; font-size: 9px; display: block;padding:10px;background:#fff; margin:10px auto 10px auto; width:320px" class="allCornersRounded">

made with <span style="font-size: 10px; color: #F33A78">♥</span> (lots and lots of it)<br />Powered by smarterscrum</div>		

<script type="text/javascript">
		var getNotifications = function() {
				$.getJSON('/notificationtasks/getlatestnews',
					function(data) {
						$(data).each(function(){
							$.gritter.add({
								title: this.madeBySysAdmin? '[SysAdmin] '+this.header : this.header,
								text: this.body,
								image: this.importance > 0 ? '/public/images/tick.png' : this.importance < 0 ? '/public/images/cross.png' : '/public/images/error.png',
								sticky: false,
								time: ''
							});
							return true;
						});
					setTimeout('getNotifications();', 1000);
					});
				}
var ping = function() {
				$.getJSON('/sessions/ping',
					function(data) {
						str = '';
						$(data).each(function() {
							// users?
							if (this.isAdmin) {
								this.name = '<span class="isAdmin">' + this.name + '</span>';
							}
							str += '<a href="/show/user?id='+this.id+'">' + this.name + '</a>, ';
						});
						
						$('#onlineUsers').html(str.substring(0,str.length-2));
						setTimeout('ping()', 1000*30);
					});
				}

			 $.extend($.gritter.options, { 
				fade_in_speed: 50, // how fast notifications fade in (string or int)
				fade_out_speed: 300, // how fast the notices fade out
				time: 5000 // hang on the screen for...
			});
			</script>

			#{ifErrors}
			<script type="text/javascript">
				$(document).ready(function(){
					$.bar({
						message : '${errors}'
					});
				})
			</script>
			#{/ifErrors}
			#{if flash.error}
			<script type="text/javascript">
			$(document).ready(function(){
				$.bar({
					message : '&{flash.error}'
				});
			})
			</script>
			#{/if}
</body>
</html>