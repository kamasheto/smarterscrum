<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <title>#{get 'title' /}</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <link rel="stylesheet" type="text/css" media="screen" href="@{'/public/stylesheets/main.css'}"/>
       	<link rel="stylesheet" type="text/css" media="screen"href="@{'/public/stylesheets/tipTip.css'}"/>
        <link rel="stylesheet" type="text/css" media="screen" href="@{'/public/stylesheets/jquery-ui-1.8.custom.css'}"/>
		<link rel="stylesheet" type="text/css" media="screen" href="@{'/public/stylesheets/BreadCrumb.css'}"/>
		<link rel="stylesheet" type="text/css" media="screen" href="/public/stylesheets/jquery.gritter.css"/>
		<link rel="shortcut icon" href="@{'public/images/favicon.ico'}" type="image/x-icon"/> 
        #{get 'moreStyles' /}
        
        <script src="@{'/public/javascripts/jquery-1.4.min.js'}" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript" src="@{'public/javascripts/jquery-ui-1.8.custom.min.js'}"> </script>
		<script type="text/javascript" src="@{'public/javascripts/timepicker.js'}"> </script>
		<script type="text/javascript" src="@{'public/javascripts/jquery.jBreadCrumb.1.1.js'}"> </script>
        <script src="@{'/public/javascripts/date.js'}" type="text/javascript" charset="utf-8"></script>
       	<script src="@{'/public/javascripts/jquery.tipTip.js'}" type="text/javascript"charset="utf-8"></script>
       	<script src="@{'/public/javascripts/md5.js'}" type="text/javascript"charset="utf-8"></script>
       	<script src="@{'/public/javascripts/more.js'}" type="text/javascript"charset="utf-8"></script>
		<script type="text/javascript" src="/public/javascripts/jquery.gritter.min.js"></script>
        #{get 'moreScripts' /}
        
        <script type="text/javascript">
       		$(function(){
/*
           	    var x = $("#login").html();
           	    $('#logger').html(x);
           	    $('#login').remove();*/
       			$("#breadCrumb").jBreadCrumb();
       			$('.formatDate').each(function(){
					$(this).html( formatDate( new Date(getDateFromFormat($(this).html(),'yyyy-MM-dd HH:mm:ss')), 'd MMM, yyyy') );
				});
       			$('.formatTime').each(function(){
					$(this).html( formatDate( new Date(Number($(this).html())), 'd MMM, yyyy hh:mma') );
				});
   			    $("a").tipTip({delay:0});
   			    $("td").tipTip({delay:0});
   			    $("span").tipTip({delay:0});
   			    
   			    $("button").addClass("ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only",0);
   			    $("a button").addClass("ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only",0);
   			    $("input[type='submit']").addClass("ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only",0);
   			    $("input[type='button']").addClass("ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only",0);
   			    $("input[type='ok']").addClass("ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only",0);
   			    $("input[type='add']").addClass("ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only",0);
   			    $("input[type='send']").addClass("ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only",0);
   			
			    
   			    $('div.crudField').each(function(){
						if ($(this).html().trim() == '') {
							$(this).remove();
						}
   	   			    });
   			    #{secure.check 'loggedIn'}
	 			getNotifications();
				ping();
   			    #{/secure.check}
       		});
        </script>
</head>

<body onload="#{get 'onLoad' /}">
<div style="position:relative; top:0px; right:10px">
		<div class="inline-block right" style="background-color:#111; width: 20px; height: 20px;">
			<div class="curlyNotchTopLeft"style="background: url('@{'/public/images/bg2.png'}') repeat-x fixed left -40px;">
			</div>
		</div>


	<div class="bottomCornersRounded right" style="padding: 10px 10px 10px 10px; background-color: #111; overflow: auto;">
		<input class="search" type="text" /><input class="searchBtn" type="button" value="search" /></div>
		
<div class="inline-block right" style="background-color:#111; width: 20px; height: 20px;">
			<div class="curlyNotchTopRight" style="background: url('@{'/public/images/bg2.png'}') repeat-x fixed left -40px;">
			</div>
</div>
</div>
<div style="background: url('@{'/public/images/bg2.png'}') repeat-x scroll left top; width: 100%;height:156px;margin-top:-40px">
<div style="margin-top:-40px"class="left"><a  href="/" title="Go back home?"><img src="@{'/public/images/smartsoft.png'}"/></a></div>
<br style="clear:both"/>
<div class="right">
#{secure.check 'systemAdmin'}
	<a class="aDIV topCornersRounded" href="/admin/projects" style="color: #E5A1A5;" title="View the admin panel">Admin Panel</a>
#{/secure.check}
<a class="aDIV topCornersRounded" href="@{About.index}" title="read aboout SmartSoft?">About Us</a>
	<a class="aDIV topCornersRounded" href="@{Show.users}" title="show users?">Users</a>
	<a class="aDIV topCornersRounded" href="@{Show.projects}" title="view all projects?">Projects</a> </div>
</div>

<div class="topper">
#{secure.check 'loggedIn'}
	Hello ${controllers.Security.getConnected().name}!&nbsp;&nbsp;|&nbsp;&nbsp;
	<a href="/show/user?id=${controllers.Security.getConnected().id}">Profile</a>&nbsp;&nbsp;|&nbsp;&nbsp;
	<a href="@{Projects.myProjects()}" style="width: 120px !important" title="Want to see your projects?">My Projects</a>&nbsp;&nbsp;|&nbsp;&nbsp;
	<a href="#" id="chatlink"onclick="$('#chatroomList').slideToggle(200);$('#chatlink').toggleClass('topCornersRounded white')">Chatroom</a>&nbsp;&nbsp;|&nbsp;&nbsp;
	<a href="/secure/logout" title="Logout from the system">[x] Logout</a>&nbsp;&nbsp;|&nbsp;&nbsp;
#{/secure.check}
Switch Theme&nbsp;&nbsp;
<a href="@{Accounts.register}" #{secure.check 'loggedIn'} style="display:none"#{/secure.check}>|&nbsp;&nbsp;Register</a>
#{secure.check 'loggedIn'}
<br/>
<div id="chatroomList" style="text-align:center; color:#fff;display:none; position:absolute;z-index:100">
 	<div class="allCornersRounded"style="padding:5px;background-color:#555;width:100px;overflow auto;margin-left:250px" >
 	#{list controllers.Security.getConnected().projects, as:'proj'}
 	<a href="#" onclick="signIn(${proj.chatroom.id}); $('#chatContainer_${proj.name}').slideToggle(400)">${proj.name}</a><br/>
	
 	
 	#{/list}
	</div>
	</div>


</div>


<div id="chatContainer">
#{list controllers.Security.getConnected().projects, as:'proj'}
<div id="chatContainer_${proj.name}" style="display:none;position:absolute; z-index:100;">
<div class="chatContainerHeader"><a href="#" title="hide/show chat?" onclick="$('#chatHolder_${proj.name}').slideToggle(400);" style="text-decoration:none; color:#fff">${proj.name} Chat</a></div>
<div id="chatHolder_${proj.name}">
	<div id="thread_${proj.name}" class="thread">
		<div>
			<span class="ui-icon ui-icon-extlink inline-block"></span><span class="ui-icon ui-icon-person inline-block"></span><span class="ui-icon ui-icon-circle-close inline-block"></span>
		</div>
		<script type="text/html" id="message_tmpl">
			<div class="allCornersRounded <%= message.author == 'notice' ? 'notice' : message.author == '${connected.name}' ? 'you border-callout' : 'them border-callout' %>">		
				<strong class="title" style="<%= message.author == 'notice' ? 'display:none !important' : '' %>"><%= message.author%></strong> 
				<%= message.message.replace('\n', '<br/>') %>
			</div>
		</script>
	</div>
	<div id="newMessage">	
		<textarea id="message_${proj.name}" name="message_${proj.name}" class="chatTextArea"></textarea>
		<input type="button" value="send" id="send_${proj.name}" class="chatBtn"/>
	</div>	
	<script type="text/javascript">
	$('#send_${proj.name}').click(function() {
		var message = $('#message_${proj.name}').val();
		$('#message_${proj.name}').val('');
		$.post('@{ChatSystem.addMessage()}', {message: message , id:${proj.chatroom.id}}); 
		$('#message_${proj.name}').focus(); 
	});
	
	// Retrieve new messages
		var getMessages = function() {
			$.getJSON('/ChatSystem/newMessages',{id:${proj.chatroom.id}}, function(messages) {
				$(messages).each(function() {
					display(this);
				});
				setTimeout('getMessages();', 500);
			});
		}	
		$(function() {
			getMessages();
		});
		
	// Display a message
	var display = function(message) {
		$('#thread_${proj.name}').append(tmpl('message_tmpl', {message: message}));
		var obj = document.getElementById('thread_${proj.name}');
		obj.scrollTop = obj.scrollHeight;
	}
	
	function signIn(id)
	{
		$.post('/ChatSystem/enterChat',{id:id});
	}
	
	function signOut(id)
	{
		$.post('/ChatSystem/leaveChat',{id:id});
	}
	</script>
	#{/list}
	</div>
	</div>
	#{/secure.check}
</div>
<table cellpadding="0" style="width: 100%" class="myTables">
	<tr>
		<td>
		<table cellpadding="0" class="myTables" style="width: 100%; overflow: auto">
			<tr>
				<td style="width: 47px">
				<img alt="" src="@{'/public/images/topleft.png'}" /></td>
				<td>
				<div class="left" style="position:relative;z-index:0;background: url('@{'/public/images/topcenter.png'}') repeat-x scroll left top; height: 43px; width: 100%">
				</div>
				</td>
				<td style="width: 47px">
				<img alt="" src="@{'/public/images/topright.png'}" /></td>
			</tr>
		</table>
		</td>
	</tr>
	<tr>
		<td>
		<div style="padding: 0px 14px 0px 14px; vertical-align: top">
			<div style="background-color: #fff; overflow: auto;">
				<table style="width: 100%" class="myTables">
					<tr>
						<td style="width: 200px; vertical-align: top; border-right:1px #ddd solid">
						<div id="logger">
					
						
						</div>
						#{secure.check 'loggedIn'}
						<div class="sideBar bottomCornersRounded" style="vertical-align: top">
							<div class="block">
								<div class="left inline-block" style="color: rgb(158, 53, 114); margin-top:10px;font-size:30px;line-height:10px;">{</div>
								<div class="sideBarHeading inline-block left">Tools</div>		
								<div class="left inline-block"  style="color: rgb(158, 53, 114); margin-top:10px;font-size:30px;line-height:10px;">}</div>
							</div>
							<br style="clear:both"/>
							<div class="sideBarElements">
								#{get 'moreLinks' /}
								#{get 'moreControls'/}
							</div>
						</div>
						#{/secure.check}
						</td>
						<td style="vertical-align: top; padding: 10px;">
						<div class="left" style="width: 100%; vertical-align: top">
							#{secure.check 'loggedIn'}
							<div id="breadCrumb" class="breadCrumb module">
								<ul>
									<li><a href="/">Home</a></li>
									<li>#{get 'crumbs' /} </li>
								</ul>
							</div>
										
							
							#{/secure.check}
							<br/>
							<div id="content"style="margin-top:35px">
							#{doLayout /}
							</div>
						</div>
						</td>
					</tr>
				</table>
			</div>
		</div>
		</td>
	</tr>
	<tr>
		<td>
		<table class="myTables"cellpadding="0" class="myTables" style="width: 100%; overflow: auto">
			<tr>
				<td style="width: 43px">
				<img alt="" src="@{'/public/images/bottomleft.png'}" /></td>
				<td>
				<div class="left" style="position:relative;z-index:0;background: url('@{'/public/images/bottomcenter.png'}') repeat-x scroll left top; height: 43px; width: 100%">
				</div>
				</td>
				<td style="width: 43px">
				<img alt="" src="@{'/public/images/bottomright.png'}" /></td>
			</tr>
		</table>
		</td>
	</tr>
</table>


<div style="text-align: center; font-size: 9px; display: block;padding:10px;background:#fff; margin:10px auto 10px auto; width:320px" class="allCornersRounded">

			all rights reserved &copy; smartsoft, 2010 <br/> made with <span style="font-size: 10px; color: #F33A78">♥</span> (lots and lots of it) </div>		

<script type="text/javascript">
		var getNotifications = function() {
				$.getJSON('/notificationtasks/getlatestnews',
					function(data) {
						$(data).each(function(){
							$.gritter.add({
								title: this.madeBySysAdmin? '[SysAdmin] '+this.header : this.header,
								text: this.body,
								image: this.importance > 0 ? '/public/images/tick.png' : this.importance < 0 ? '/public/images/cross.png' : '/public/images/error.png',
								sticky: false,
								time: ''
							});
							return true;
						});
					setTimeout('getNotifications();', 1000);
					});
				}
var ping = function() {
				$.getJSON('/sessions/ping',
					function(data) {
						str = '';
						$(data).each(function() {
							// users?
							if (this.isAdmin) {
								this.name = '<span class="isAdmin">' + this.name + '</span>';
							}
							str += '<a href="/show/user?id='+this.id+'">' + this.name + '</a>, ';
						});
						
						$('#onlineUsers').html(str.substring(0,str.length-2));
						setTimeout('ping()', 1000*30);
					});
				}

			 $.extend($.gritter.options, { 
				fade_in_speed: 50, // how fast notifications fade in (string or int)
				fade_out_speed: 300, // how fast the notices fade out
				time: 5000 // hang on the screen for...
			});
			</script>


</body>

</html>

