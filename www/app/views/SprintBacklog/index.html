#{extends 'main.html' /} #{set title:'Sprint Backlog' /} 
#{set 'moreStyles'}
<style type="text/css">
thead
{
cursor:move;
}
</style>
#{/set}
#{set 'moreScripts'}

<script language="javascript" type="text/javascript"
	src="@{'/public/javascripts/jeditable-mod.js'}"></script>

<script  type="text/javascript" src="@{'/public/javascripts/dragtablenorm.js/'}" ></script>
<script  type="text/javascript" src="@{'/public/javascripts/sorttable.js/'}" ></script>
<script type="text/javascript">
function popUp(URL) 
{
day = new Date();
id = day.getTime();
eval("page" + id + " = window.open(URL, '" + id + "', 'toolbar=0,scrollbars=1,location=0,statusbar=0,menubar=0,resizable=1,width=200,height=400,left = 583,top = 184');");
}
$(function() 
{	
	$(".enterEffort").each(function()
	{
		if($(this).html()!='')
			$(this).html(parseInt($(this).html()));
	});

	$(".editPOINTS").each(function()
	{
		if($(this).html()!='')
			$(this).html(parseInt($(this).html()));
	});
	
	/**
	 * This function enables the inplace editing for the effort point for a day.
	 * they have the class, enterEfforts
	 *
	 * @author Hadeer Younis
	 * @category C4S1
	 * @see	   inplace-editing, popups
	 */
		
    $('.enterEffort').editable(
    function(value)
    {
        var theId 		= $('#lolid').closest("td").attr("id");
        var splitted 	= theId.split("_");
        var taskId 		= parseInt(splitted[1]);
        var dayId 		= parseInt(splitted[2])-1;
        var max			= parseInt(splitted[3]);
        var original	= parseInt(splitted[4]);
    	var points 		= parseInt(value);
    	if(points>max)
    	{
    		alert('Please enter a number between 0 & '+max);
    		return(original);
    	}
    	else if(isNaN(points))
    	{
    		alert('Please enter a number!');
    		return(original);
    	}
    	else
    	{	
    		$.post('@{Tasks.enterEffort()}',
    				{id:taskId,effort:points,day:dayId});     
        	
        	return(value);
    	}      
    },
    {    
        indicator : 'Saving...',
    });
    /**
     * The following functions enables the inplace editing for description, type, reviewer, points, assignee of a task.
     * everyone with their class.
     *
     *
     * @author Menna Ghoneim
     * @category C4S6
     * @see	   inplace-editing, popups
     */
        
    $('.editDES').editable(
    	    function(value)
    	    {
    	        var taskId 	= parseInt($('#lolid').closest("td").attr("id"));
    	       
    	        $.post('@{Tasks.editTaskDesc()}',
    	            {id:taskId, desc:value});

        	    return(value);
    	        
    	    },
    	    {    
    	        indicator : 'Saving...',
    	        tooltip   : 'Click to edit...'
    	    });
    
    
    $('.editPOINTS').editable(
    	    function(value)
    	    {
    	        var theId 		= $('#lolid').closest("td").attr("id");
    	        var splitted 	= theId.split("_");
    	        var taskId 		= parseInt(splitted[0]);
    	        var original	= parseInt(splitted[1]);
    	    	var points 		= parseInt(value);
    	        
    	    	if(isNaN(points))
    	    	{
    	    		alert('Please enter a number!');
    	    		return(original);
    	    	}
    	    	else
    	    	{	
    	    		$.post('@{Tasks.editTaskEstimation()}',
    	    				{id:taskId,estimation:points});
    	    		$('#lolid').closest("td").attr("id",taskId+"_"+points);
    	    		$("td[id^=EF_"+taskId+"_]").each(function()
    	    	    		{
    	    	        		var theId 		= $(this).attr("id");
    	    	        		var splitted 	= theId.split("_");
    	    	       			var taskId 		= parseInt(splitted[1]);
    	    	        		var dayId 		= parseInt(splitted[2])-1;
    	    	        		var max			= parseInt(splitted[3]);
    	    	        		var original	= parseInt(splitted[4]);
	    	    				$(this).attr("id","EF_"+taskId+"_"+dayId+"_"+points+"_"+original);
	    	    			}
	    			);

    	        	return(value);  
    	    	}      
    	    },
    	    {    
    	        indicator : 'Saving...',
    	        tooltip   : 'Click to edit...'
    	    });

    
    

 
 });

</script>

#{/set}




<!--
@author menna_ghoneim
	Looping on the list of tasks rendered to this page and putting the attributes of each 
	task (description, assignee name, total estimation points, and points per day) 
	in the table, in addition to an option to edit if the user is a scrum master  and the 
	sprint is not in progress 
-->
 <br/>
 

#{set 'crumbs'}
<li><a href="/show/projects">Projects</a></li>
<li><a href="/show/project?id=${projectId}">${pName}</a></li>
<li><a href="/sprints/showsprints?projectId=${projectId}">Sprints</a></li>
<li><a href="@{Sprints.showsprint(id,projectId)}" >Sprint ${sNum}</a></li>
<li><a href="@{SprintBacklog.index(componentID,id)}">Sprint backlog</a></li>
#{/set}


<div id="sprint">
#{ifnot taskOfStory}
#{if incomp}
The component has no tasks yet.
#{/if}
#{else}
You are not a user in this component, you cannot view their tasks.
#{/else}
#{/ifnot} 
#{else}

<h2>Sprint Backlog</h2>

	#{set 'moreLinks'}
	<div class="clear"></div>
				<!--@author ahmedkhaled7 C4S12/c4S4/c4s5   -->
			<a onclick="$('#checklist').toggle()" href="#">Customize columns</a><br/>
			<!--@author Hadeer Younis C4 S8-->
			<a title="Take a look at the chart?" href="@{SprintBacklog.showGraph(id,componentID)}"> Show Burn Down Chart </a><br/>
			<!--@author Hossam Amer C4 S10, S11  -->
			<a title="Take a look at the Review Log?"href="@{ReviewLog.showMeetings(projectId, componentID, id)}">View Review Log</a>
	#{/set}

	 #{if connected.in(project).can('editBacklog')}
          <span style="display:none"> ${flag=true}</span>
     #{/if}
          
	#{ifnot flag}
	<div id="NOTE"style="padding: 10px 10px 10px 10px" class="ui-state-highlight ui-corner-all"> 
	<span style="float: left; margin-right: 0.3em;" class="ui-icon ui-icon-info"></span>
	<strong>NOTE: </strong>Editing is not allowed. 
	<br/><a href="#" onclick="$('#NOTE').css('display','none');">hide me?</a></div>
	#{/ifnot}

<!--@author ahmedkhaled7 c4S4/c4s5  
check boxes for choosing the columns to be hidden -->

<div id="checklist" style="display:none">
	<h5>Show/Hide Columns</h5>
	<input type="checkbox" id="option1"><label for="option1">Description</label><br/>
	<input type="checkbox" id="option2"><label for="option2">Type</label><br/>
	<input type="checkbox" id="option7"><label for="option7">Status</label><br/>
	<input type="checkbox" id="option3"><label for="option3">Assignee</label><br/>
	<input type="checkbox" id="option4"><label for="option4">Reviewer</label><br/>
	<input type="checkbox" id="option5"><label for="option5">Total Points</label><br/>
	<input type="checkbox" id="option6"><label for="option6">Efforts</label><br/>
	
	<button onclick="customize_columns();">Hide</button>
</div>





#{list items:taskOfStory, as:'storyTask'}

<table class="draggable sortable">

	<thead>
<tr>
		<td>ID</td>
		<td class="shDes">Description</td>
		<td class="shType">Type</td>
		<td class="shStatus">Status</td>
		<td class="shAssignee">Assignee</td>
		<td class="shReviewer">Reviewer</td>
		<td class="shPoints">Total Points</td>
		#{list items:daysHeader, as:'day'}
		<td class="shEfforts">Day ${day}</td>
		#{/list}
	</tr>
	</thead>

	#{list items:storyTask, as:'task'}

	<tr id="task_${task.id}">

		<td><a title="view the task reports?" href="@{Tasks.getReport(task.id)}">${task.id}</a></td>

         
        
         #{ifnot user.id==task.assignee.id || flag}

          #{ifnot task.description}
          <td class="shDes">No Description stated</td>
          #{/ifnot}
          #{else}
          <td class="shDes">${task.description}</td>
          #{/else}
          
          #{ifnot task.taskType}
          <td class="shType">No Type stated</td>
          #{/ifnot}
          #{else}
          <td class="shType">${task.taskType.name}</td>
          #{/else}
          
           #{ifnot task.taskStatus}
          <td class="shStatus">No Status stated</td>
          #{/ifnot}
          #{else}
          <td class="shStatus">${task.taskStatus.name}</td>
          #{/else}
        
          #{ifnot task.assignee}
          <td class="shAssignee">No assignee stated</td>
          #{/ifnot}
          #{else}
          <td class="shAssignee>${task.assignee.name}</td>
          #{/else}
        
         #{ifnot task.reviewer}
          <td class="shReviewer">No reviewer stated</td>
          #{/ifnot}
          #{else}
          <td class="shReviewer">${task.reviewer.name}</td>
          #{/else}
        
         #{ifnot task.estimationPoints}
          <td class="shPoints">&nbsp;</td>
          #{/ifnot}
          #{else}
          <td class="shPoints">${task.estimationPoints}</td>
          #{/else}
        
        <!--@author Hadeer Younis C4 S8-->
        #{list items:daysHeader, as:'day'}
		<td class="shEfforts"style="text-align: center" id="${day}_${task.id}_${task.estimationPoints}" >
		#{if task.getEffortPerDay(day-1)==-1.0}&nbsp;
		#{/if} #{else} ${task.getEffortPerDay(day-1)} #{/else}</td>
		#{/list}
	
        
         #{/ifnot}
      
            
      
         #{else}
		#{ifnot task.description}
		<td class="shDes"><span id="${task.id}" class="editDES">No description stated
		</span></td>
		#{/ifnot} #{else}
		<td class="editDES shDes" title="edit the description?" id="${task.id}">${task.description}</td>
		#{/else} 
		
		#{ifnot task.taskType}
		<td id="${task.id}" class="editTYPE shType">
		#{secure.check 'canChangeTaskType'}
		<a title="Enter a task type??"HREF="javascript:popUp('@{Tasks.chooseTaskType(task.id)}')">No type chosen</a>
	    #{/secure.check}
		No type chosen
		</td>
		#{/ifnot} 
		#{else}
		<td id="${task.id}" title="edit the task type?" class="editTYPE shType">
		#{secure.check 'canChangeTaskType'}
		<a title="Change the task type??" HREF="javascript:popUp('@{Tasks.chooseTaskType(task.id)}')">${task.taskType.name}</a>
		#{/secure.check}
</td>
		#{/else} 
		
		#{ifnot task.taskStatus}
		<td id="${task.id}" class="editStatus shStatus">
		<a title="Add the task Status??"HREF="javascript:popUp('@{Tasks.chooseTaskStatus(task.id)}')">No status chosen</a>
		No status chosen
		</td>
		#{/ifnot}
		 #{else}
		<td id="${task.id}" title="edit the task type?" class="editStatus shStatus">
		<a title="edit the task status??"HREF="javascript:popUp('@{Tasks.chooseTaskStatus(task.id)}')">
		${task.taskStatus.name}</a></td>
		#{/else}
		
		 #{ifnot task.assignee}
		<td id="${task.id}_assigneee" class="editASSI shAssignee"><a title="Choose an assignee?"HREF="javascript:popUp('@{Tasks.chooseTaskAssiRev(task.id,0)}')">
		
		Choose assignee</a></td>
		#{/ifnot}
		 #{else}
		<td id="${task.id}_assigneee" class="editASSI shAssignee"><a  title="change assignee?" HREF="javascript:popUp('@{Tasks.chooseTaskAssiRev(task.id,0)}')">
		${task.assignee.name}</a>
		
		</td>
		#{/else} 
		
		#{ifnot task.reviewer}
		<td id="${task.id}" class="editREV shReviewer"><a title="Add a reviewer?"HREF="javascript:popUp('@{Tasks.chooseTaskAssiRev(task.id,1)}')">
		No reviewer chosen</a>
		</td>
		#{/ifnot} 
		#{else}
		<td id="${task.id}" title="Change the reviewer?" class="editREV shReviewer"><a HREF="javascript:popUp('@{Tasks.chooseTaskAssiRev(task.id,1)}')">
		${task.reviewer.name}</a>
		</td>
		#{/else} 
		
		#{ifnot task.estimationPoints}
		<td id="${task.id}" class="editPOINTS shPoints">No points 
		</td>
		#{/ifnot}
		 #{else}
		<td id="${task.id}_${task.estimationPoints}" title="edit the estimationpoints?"
			class="editPOINTS shPoints" style="text-align: center">${task.estimationPoints}</td>
		#{/else}

		<!--@author Hadeer Younis C4 S8-->
		#{list items:daysHeader, as:'day'}
		<td style="text-align: center"id="EF_${task.id}_${day}_${task.estimationPoints}_${task.getEffortPerDay(day-1)}" class="enterEffort shEfforts">
		#{if task.getEffortPerDay(day-1)==-1.0}$nbsp;
		#{/if} #{else} ${task.getEffortPerDay(day-1)} #{/else}</td>
		#{/list}
		#{/else}
	</tr>

	#{/list}
</table>
<br />
#{/list}
 #{/else} 
 
 <script type="text/javascript">
/**
 * This function checks which check boxes are checked 
 so i can hide the columns coresponding to them and 
 show the rest
 *
 * @author ahmedkhaled7
 * @category C4S4/C4S5
 * @see	   hide and show columns
 */
function customize_columns()
{
	if($('#option1').is(':checked')==true)	
		$('.shDes').css('display','none');
	else
		$('.shDes').css('display','tabel-cell');

	if($('#option2').is(':checked')==true)	
		$('.shType').css('display','none');
	else
		$('.shType').css('display','table-cell');

	if($('#option3').is(':checked')==true)	
		$('.shAssignee').css('display','none');
	else
		$('.shAssignee').css('display','table-cell');

	if($('#option4').is(':checked')==true)	
		$('.shReviewer').css('display','none');
	else
		$('.shReviewer').css('display','table-cell');

	if($('#option5').is(':checked')==true)	
		$('.shPoints').css('display','none');
	else
		$('.shPoints').css('display','table-cell');

	if($('#option6').is(':checked')==true)	
		$('.shEfforts').css('display','none');
	else
		$('.shEfforts').css('display','table-cell');

	if($('#option7').is(':checked')==true)	
		$('.shStatus').css('display','none');
	else
		$('.shStatus').css('display','table-cell');

}

</script>
</div>